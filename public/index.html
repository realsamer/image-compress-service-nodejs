<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Compression Service</title>
    <style>
      body {
        font-family: system-ui, Arial;
        max-width: 900px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        flex: 1;
        min-width: 280px;
      }
      img {
        max-width: 100%;
        border-radius: 10px;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      .muted {
        color: #666;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>Image Compression Service</h1>
    <p class="muted">
      Upload an image, choose quality/format, and download the compressed
      result.
    </p>

    <div class="card">
      <label><strong>Choose image:</strong></label
      ><br />
      <input id="file" type="file" accept="image/*" /><br /><br />

      <label><strong>Format:</strong></label>
      <select id="format">
        <option value="jpeg">JPEG</option>
        <option value="webp">WEBP</option>
        <option value="png">PNG (lossless)</option>
      </select>

      <br /><br />
      <label><strong>Quality:</strong> <span id="qVal">75</span></label
      ><br />
      <input id="quality" type="range" min="1" max="100" value="75" />

      <br /><br />
      <button id="btn">Compress & Download</button>
      <p id="status" class="muted"></p>
    </div>

    <div class="row" style="margin-top: 16px">
      <div class="card">
        <h3>Original</h3>
        <p class="muted" id="origMeta"></p>
        <img id="origImg" alt="Original preview" />
      </div>

      <div class="card">
        <h3>Compressed (preview)</h3>
        <p class="muted" id="compMeta"></p>
        <img id="compImg" alt="Compressed preview" />
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("file");
      const qualityInput = document.getElementById("quality");
      const qVal = document.getElementById("qVal");
      const formatSelect = document.getElementById("format");
      const btn = document.getElementById("btn");
      const statusEl = document.getElementById("status");

      const origImg = document.getElementById("origImg");
      const compImg = document.getElementById("compImg");
      const origMeta = document.getElementById("origMeta");
      const compMeta = document.getElementById("compMeta");

      function fmtBytes(bytes) {
        const units = ["B", "KB", "MB", "GB"];
        let i = 0;
        let val = bytes;
        while (val >= 1024 && i < units.length - 1) {
          val /= 1024;
          i++;
        }
        return `${val.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
      }

      qualityInput.addEventListener("input", () => {
        qVal.textContent = qualityInput.value;
      });

      fileInput.addEventListener("change", () => {
        const f = fileInput.files?.[0];
        if (!f) return;
        origImg.src = URL.createObjectURL(f);
        origMeta.textContent = `${f.type || "image"} • ${fmtBytes(f.size)}`;
        compImg.removeAttribute("src");
        compMeta.textContent = "";
        statusEl.textContent = "";
      });

      btn.addEventListener("click", async () => {
        const f = fileInput.files?.[0];
        if (!f) {
          statusEl.textContent = "Please choose an image first.";
          return;
        }

        statusEl.textContent = "Compressing...";
        btn.disabled = true;

        try {
          const form = new FormData();
          form.append("image", f);
          form.append("quality", qualityInput.value);
          form.append("format", formatSelect.value);

          const res = await fetch("/compress", { method: "POST", body: form });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Request failed");
          }

          const blob = await res.blob();
          compImg.src = URL.createObjectURL(blob);
          compMeta.textContent = `${blob.type} • ${fmtBytes(blob.size)}`;

          // Download automatically
          const a = document.createElement("a");
          const ext =
            formatSelect.value === "jpeg" ? "jpg" : formatSelect.value;
          a.href = compImg.src;
          a.download = `compressed.${ext}`;
          document.body.appendChild(a);
          a.click();
          a.remove();

          statusEl.textContent = "Done. Download started.";
        } catch (e) {
          statusEl.textContent = `Error: ${e.message}`;
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
